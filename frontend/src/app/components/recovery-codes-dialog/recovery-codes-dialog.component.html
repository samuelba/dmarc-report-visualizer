<h2 mat-dialog-title>
  @if (step === 'verify') {
    <span>Regenerate Recovery Codes</span>
  }
  @if (step === 'display') {
    <span>Your New Recovery Codes</span>
  }
</h2>

<mat-dialog-content>
  <!-- Step 1: Verify TOTP Code -->
  @if (step === 'verify') {
    <div class="step-content">
      <app-message type="warning">
        Regenerating recovery codes will invalidate all your existing recovery codes. Make sure you have access to your
        authenticator app before proceeding.
      </app-message>

      <div class="step-instructions">
        <p>Enter the 6-digit code from your authenticator app to confirm:</p>
      </div>

      <app-totp-input [(ngModel)]="verificationCode" [disabled]="isLoading" [autofocus]="true"></app-totp-input>

      @if (errorMessage) {
        <app-message type="error">
          {{ errorMessage }}
        </app-message>
      }

      <app-message type="info" icon="schedule">
        Make sure your device time is correct. TOTP codes are time-based and expire every 30 seconds.
      </app-message>

      @if (isLoading) {
        <div class="loading-inline">
          <mat-spinner diameter="24"></mat-spinner>
          <span>Regenerating codes...</span>
        </div>
      }
    </div>
  }

  <!-- Step 2: Display New Recovery Codes -->
  @if (step === 'display') {
    <div class="step-content">
      <app-message type="warning">
        Store these codes in a safe place. Each code can only be used once to access your account if you lose your
        authenticator device. Your old recovery codes have been invalidated.
      </app-message>

      <div class="recovery-codes-grid">
        @for (code of recoveryCodes; track code) {
          <code class="recovery-code">{{ code }}</code>
        }
      </div>

      <div class="recovery-actions">
        <button mat-stroked-button (click)="copyRecoveryCodesToClipboard()" class="action-button">
          <mat-icon>content_copy</mat-icon>
          Copy All Codes
        </button>
        <button mat-stroked-button (click)="downloadCodes()" class="action-button">
          <mat-icon>download</mat-icon>
          Download as Text File
        </button>
      </div>

      <mat-checkbox [(ngModel)]="acknowledged" class="acknowledgment-checkbox" color="primary">
        I have saved my new recovery codes in a secure location
      </mat-checkbox>

      <app-message type="info">
        Keep these codes secure. Anyone with access to these codes can bypass two-factor authentication on your account.
      </app-message>
    </div>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <!-- Verify Step Actions -->
  @if (step === 'verify') {
    <ng-container>
      <button mat-button (click)="cancel()">Cancel</button>
      <button
        mat-flat-button
        color="primary"
        (click)="regenerateCodes()"
        [disabled]="!isVerificationCodeValid || isLoading"
      >
        Regenerate Codes
      </button>
    </ng-container>
  }

  <!-- Display Step Actions -->
  @if (step === 'display') {
    <ng-container>
      <button mat-flat-button color="primary" (click)="complete()" [disabled]="!acknowledged">Done</button>
    </ng-container>
  }
</mat-dialog-actions>
