<mat-card class="ips-card">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>router</mat-icon>
      Top Sender IPs with Geographic Information
    </mat-card-title>
    <mat-card-subtitle>
      Source IP addresses sending emails to your domain with location and authentication results
    </mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    @if (loading) {
      <div class="loading-container">
        <mat-spinner></mat-spinner>
        <p>Loading IP data...</p>
      </div>
    }

    @if (!loading) {
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" class="full-width-table">
          <!-- IP Address Column -->
          <ng-container matColumnDef="sourceIp">
            <th mat-header-cell *matHeaderCellDef>IP Address</th>
            <td mat-cell *matCellDef="let element">
              <div class="ip-cell">
                <code>{{ element.sourceIp }}</code>
                @if (element.latitude && element.longitude) {
                  <mat-icon class="location-icon" matTooltip="Geographic location available"> location_on </mat-icon>
                }
              </div>
            </td>
          </ng-container>

          <!-- Location Column -->
          <ng-container matColumnDef="location">
            <th mat-header-cell *matHeaderCellDef>Location</th>
            <td mat-cell *matCellDef="let element">
              <div class="location-cell">
                @if (element.country) {
                  <div class="country">
                    <mat-icon class="flag-icon">flag</mat-icon>
                    {{ getCountryName(element.country) }}
                  </div>
                }
                @if (element.city) {
                  <div class="city">
                    <mat-icon class="city-icon">location_city</mat-icon>
                    {{ element.city }}
                  </div>
                }
                @if (!element.country && !element.city) {
                  <div class="no-location">
                    <mat-icon>help_outline</mat-icon>
                    Unknown
                  </div>
                }
              </div>
            </td>
          </ng-container>

          <!-- Total Count Column -->
          <ng-container matColumnDef="count">
            <th mat-header-cell *matHeaderCellDef>Total Records</th>
            <td mat-cell *matCellDef="let element">
              <span class="count-badge">{{ element.count | number }}</span>
            </td>
          </ng-container>

          <!-- DMARC Pass Column -->
          <ng-container matColumnDef="passCount">
            <th mat-header-cell *matHeaderCellDef>DMARC Pass</th>
            <td mat-cell *matCellDef="let element">
              <div class="auth-result">
                <span class="pass-count">{{ element.passCount | number }}</span>
                <span class="percentage pass"> ({{ getPercentage(element.passCount, element.count) }}%) </span>
              </div>
            </td>
          </ng-container>

          <!-- DKIM Pass Column -->
          <ng-container matColumnDef="dkimPass">
            <th mat-header-cell *matHeaderCellDef>DKIM Pass</th>
            <td mat-cell *matCellDef="let element">
              <div class="auth-result">
                <span class="pass-count">{{ element.dkimPassCount | number }}</span>
                <span class="percentage pass"> ({{ getPercentage(element.dkimPassCount, element.count) }}%) </span>
              </div>
            </td>
          </ng-container>

          <!-- SPF Pass Column -->
          <ng-container matColumnDef="spfPass">
            <th mat-header-cell *matHeaderCellDef>SPF Pass</th>
            <td mat-cell *matCellDef="let element">
              <div class="auth-result">
                <span class="pass-count">{{ element.spfPassCount | number }}</span>
                <span class="percentage pass"> ({{ getPercentage(element.spfPassCount, element.count) }}%) </span>
              </div>
            </td>
          </ng-container>

          <!-- DMARC Fail Column -->
          <ng-container matColumnDef="failCount">
            <th mat-header-cell *matHeaderCellDef>DMARC Fail</th>
            <td mat-cell *matCellDef="let element">
              <div class="auth-result">
                <span class="fail-count">{{ element.failCount | number }}</span>
                <span class="percentage fail"> ({{ getPercentage(element.failCount, element.count) }}%) </span>
              </div>
            </td>
          </ng-container>

          <!-- Success Rate Column -->
          <ng-container matColumnDef="successRate">
            <th mat-header-cell *matHeaderCellDef>Success Rate</th>
            <td mat-cell *matCellDef="let element">
              <div class="success-rate">
                <mat-progress-bar
                  mode="determinate"
                  [value]="getPercentage(element.passCount, element.count)"
                  [color]="getProgressBarColor(element.passCount, element.count)"
                >
                </mat-progress-bar>
                <span class="rate-text"> {{ getPercentage(element.passCount, element.count) }}% </span>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>

        <mat-paginator
          #paginator
          [length]="totalCount"
          [pageSize]="pageSize"
          [pageIndex]="currentPage"
          [pageSizeOptions]="[10, 25, 50, 100]"
          (page)="onPageChange($event)"
          showFirstLastButtons
        >
        </mat-paginator>
      </div>
    }
  </mat-card-content>
</mat-card>
