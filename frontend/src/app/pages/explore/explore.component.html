<div class="explore-container">
  <div class="explore-content">
    <section class="filters">
      <app-combined-date-filter
        [value]="dateFilterValue"
        (valueChange)="onDateFilterChange($event)"
      ></app-combined-date-filter>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Domain (Report)</mat-label>
        <mat-select [(ngModel)]="filters.domain" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of domains()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Disposition</mat-label>
        <mat-select [(ngModel)]="filters.disposition" multiple (selectionChange)="onFilterChange()">
          <mat-option value="none">none</mat-option>
          <mat-option value="quarantine">quarantine</mat-option>
          <mat-option value="reject">reject</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>DKIM</mat-label>
        <mat-select [(ngModel)]="filters.dkim" multiple (selectionChange)="onFilterChange()">
          <mat-option value="pass">pass</mat-option>
          <mat-option value="fail">fail</mat-option>
          <mat-option value="missing">missing</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>SPF</mat-label>
        <mat-select [(ngModel)]="filters.spf" multiple (selectionChange)="onFilterChange()">
          <mat-option value="pass">pass</mat-option>
          <mat-option value="fail">fail</mat-option>
          <mat-option value="missing">missing</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Source IP</mat-label>
        <mat-select [(ngModel)]="filters.sourceIp" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of ips()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Header From</mat-label>
        <mat-select [(ngModel)]="filters.headerFrom" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of headerFroms()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Envelope From</mat-label>
        <mat-select [(ngModel)]="filters.envelopeFrom" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of envelopeFroms()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Envelope To</mat-label>
        <mat-select [(ngModel)]="filters.envelopeTo" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of envelopeTos()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>DKIM Domain</mat-label>
        <mat-select [(ngModel)]="filters.dkimDomain" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of dkimDomains()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>SPF Domain</mat-label>
        <mat-select [(ngModel)]="filters.spfDomain" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of spfDomains()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Country</mat-label>
        <mat-select [(ngModel)]="filters.country" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of sortedCountries()" [value]="v">{{ getCountryName(v) }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Forwarded</mat-label>
        <mat-select [(ngModel)]="filters.isForwarded" (selectionChange)="onFilterChange()">
          <mat-option value="">All</mat-option>
          <mat-option value="true">Yes</mat-option>
          <mat-option value="false">No</mat-option>
          <mat-option value="unknown">Unknown</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="contains-filter">
        <mat-label>Contains (search all columns)</mat-label>
        <input matInput [(ngModel)]="filters.contains" (input)="onFilterChange()" placeholder="Search..." />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
      <div class="actions">
        <button matButton="filled" color="primary" (click)="apply()">Apply</button>
        <button matButton="text" (click)="clear()">Clear</button>
      </div>
    </section>

    <section>
      <table
        mat-table
        [dataSource]="rows()"
        [multiTemplateDataRows]="true"
        matSort
        (matSortChange)="onSort($event)"
        class="mat-elevation-z1"
      >
        <ng-container matColumnDef="expand">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let r">
            <button mat-icon-button (click)="toggleExpand(r)">
              <mat-icon>{{ expandedRow === r ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
          </td>
        </ng-container>
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="date">Date</th>
          <td mat-cell *matCellDef="let r">{{ r.report?.beginDate | date: 'short' }}</td>
        </ng-container>
        <ng-container matColumnDef="org">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="orgName">Reporting Org</th>
          <td mat-cell *matCellDef="let r">{{ r.report?.orgName || 'N/A' }}</td>
        </ng-container>
        <ng-container matColumnDef="ip">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="ip">IP</th>
          <td mat-cell *matCellDef="let r">{{ r.sourceIp }}</td>
        </ng-container>
        <ng-container matColumnDef="count">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="count">Count</th>
          <td mat-cell *matCellDef="let r">{{ r.count }}</td>
        </ng-container>
        <ng-container matColumnDef="disp">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="disposition">Disposition</th>
          <td mat-cell *matCellDef="let r">
            <span [class]="getDispositionClass(r.disposition)">
              {{ getDispositionIcon(r.disposition) }} {{ r.disposition }}
            </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="dkim">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="dkim">DKIM</th>
          <td mat-cell *matCellDef="let r">
            <span [class]="getDkimAuthClass(r)"> {{ getDkimAuthIcon(r) }} {{ getDkimAuthLabel(r) }} </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="spf">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="spf">SPF</th>
          <td mat-cell *matCellDef="let r">
            <span [class]="getSpfAuthClass(r)"> {{ getSpfAuthIcon(r) }} {{ getSpfAuthLabel(r) }} </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="forwarded">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="isForwarded">Forwarded</th>
          <td mat-cell *matCellDef="let r">
            <span [class]="getForwardedClass(r)" [title]="r.forwardReason || ''">
              {{ getForwardedIcon(r) }} {{ getForwardedLabel(r) }}
            </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="country">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="country">Country</th>
          <td mat-cell *matCellDef="let r">{{ getCountryName(r.geoCountry) }}</td>
        </ng-container>
        <ng-container matColumnDef="from">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="headerFrom">Header From</th>
          <td mat-cell *matCellDef="let r">{{ r.headerFrom }}</td>
        </ng-container>
        <ng-container matColumnDef="envelopeTo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="envelopeTo">Envelope To</th>
          <td mat-cell *matCellDef="let r">{{ r.envelopeTo }}</td>
        </ng-container>
        <ng-container matColumnDef="auth">
          <th mat-header-cell *matHeaderCellDef>Auth Results</th>
          <td mat-cell *matCellDef="let r">
            <div class="auth">
              <div class="dkim" *ngIf="r.dkimResults?.length">
                <strong>DKIM:</strong> <span [innerHTML]="formatDkimResultsColored(r)"></span>
              </div>
              <div class="spf" *ngIf="r.spfResults?.length">
                <strong>SPF:</strong> <span [innerHTML]="formatSpfResultsColored(r)"></span>
              </div>
              <div *ngIf="!r.dkimResults?.length && !r.spfResults?.length" class="auth-missing">âšª No auth results</div>
            </div>
          </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let r">
            <button mat-button color="primary" (click)="viewXml(r)">XML</button>
          </td>
        </ng-container>

        <ng-container matColumnDef="detail">
          <td mat-cell *matCellDef="let r" [attr.colspan]="displayed.length">
            <div *ngIf="expandedRow === r" class="detail-content">
              <div class="detail-section">
                <h4>Identifiers</h4>
                <div><strong>Envelope From:</strong> {{ r.envelopeFrom || 'N/A' }}</div>
                <div><strong>Envelope To:</strong> {{ r.envelopeTo || 'N/A' }}</div>
              </div>

              <div class="detail-section" *ngIf="r.reasonType || r.reasonComment">
                <h4>Policy Override</h4>
                <div *ngIf="r.reasonType"><strong>Reason Type:</strong> {{ r.reasonType }}</div>
                <div *ngIf="r.reasonComment"><strong>Reason Comment:</strong> {{ r.reasonComment }}</div>
              </div>

              <div class="detail-section" *ngIf="r.isForwarded !== undefined && r.isForwarded !== null">
                <h4>Forwarding Detection</h4>
                <div>
                  <strong>Forwarded:</strong>
                  <span [class]="getForwardedClass(r)"> {{ getForwardedIcon(r) }} {{ getForwardedLabel(r) }} </span>
                </div>
                <div *ngIf="r.forwardReason"><strong>Reason:</strong> {{ r.forwardReason }}</div>
              </div>

              <div class="detail-section" *ngIf="r.report?.policy">
                <h4>Published Policy</h4>
                <div class="policy-grid">
                  <div *ngIf="r.report.policy.p">
                    <strong>Policy:</strong>
                    <span [class]="getPolicyClass(r.report.policy.p)">{{ r.report.policy.p }}</span>
                  </div>
                  <div *ngIf="r.report.policy.sp">
                    <strong>Subdomain Policy:</strong>
                    <span [class]="getPolicyClass(r.report.policy.sp)">{{ r.report.policy.sp }}</span>
                  </div>
                  <div *ngIf="r.report.policy.adkim"><strong>DKIM Alignment:</strong> {{ r.report.policy.adkim }}</div>
                  <div *ngIf="r.report.policy.aspf"><strong>SPF Alignment:</strong> {{ r.report.policy.aspf }}</div>
                  <div *ngIf="r.report.policy.pct !== undefined">
                    <strong>Percentage:</strong> {{ r.report.policy.pct }}%
                  </div>
                  <div *ngIf="r.report.policy.fo"><strong>Failure Options:</strong> {{ r.report.policy.fo }}</div>
                </div>
              </div>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayed"></tr>
        <tr mat-row *matRowDef="let row; columns: displayed" class="element-row"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: ['detail']"
          class="detail-row"
          [class.expanded]="expandedRow === row"
        ></tr>
      </table>

      <mat-paginator
        [length]="total()"
        [pageSize]="pageSize()"
        [pageIndex]="page() - 1"
        [pageSizeOptions]="[10, 25, 50, 100]"
        showFirstLastButtons
        (page)="onPage($event)"
      ></mat-paginator>
    </section>
  </div>
</div>
