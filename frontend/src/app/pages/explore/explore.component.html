<div class="explore-container">
  <div class="explore-content">
    <section class="filters">
      <app-combined-date-filter
        [value]="dateFilterValue"
        (valueChange)="onDateFilterChange($event)"
      ></app-combined-date-filter>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Domain (Report)</mat-label>
        <mat-select [(ngModel)]="filters.domain" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of domains()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Reporting Org</mat-label>
        <mat-select [(ngModel)]="filters.orgName" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of orgNames()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Disposition</mat-label>
        <mat-select [(ngModel)]="filters.disposition" multiple (selectionChange)="onFilterChange()">
          <mat-option value="none">none</mat-option>
          <mat-option value="quarantine">quarantine</mat-option>
          <mat-option value="reject">reject</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>DKIM</mat-label>
        <mat-select [(ngModel)]="filters.dkim" multiple (selectionChange)="onFilterChange()">
          <mat-option value="pass">pass</mat-option>
          <mat-option value="fail">fail</mat-option>
          <mat-option value="missing">missing</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>SPF</mat-label>
        <mat-select [(ngModel)]="filters.spf" multiple (selectionChange)="onFilterChange()">
          <mat-option value="pass">pass</mat-option>
          <mat-option value="fail">fail</mat-option>
          <mat-option value="missing">missing</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Source IP</mat-label>
        <mat-select [(ngModel)]="filters.sourceIp" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of ips()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Header From</mat-label>
        <mat-select [(ngModel)]="filters.headerFrom" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of headerFroms()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Envelope From</mat-label>
        <mat-select [(ngModel)]="filters.envelopeFrom" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of envelopeFroms()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Envelope To</mat-label>
        <mat-select [(ngModel)]="filters.envelopeTo" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of envelopeTos()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>DKIM Domain</mat-label>
        <mat-select [(ngModel)]="filters.dkimDomain" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of dkimDomains()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>SPF Domain</mat-label>
        <mat-select [(ngModel)]="filters.spfDomain" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of spfDomains()" [value]="v">{{ v }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Country</mat-label>
        <mat-select [(ngModel)]="filters.country" multiple (selectionChange)="onFilterChange()">
          <mat-option *ngFor="let v of sortedCountries()" [value]="v">{{ getCountryName(v) }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Forwarded</mat-label>
        <mat-select [(ngModel)]="filters.isForwarded" (selectionChange)="onFilterChange()">
          <mat-option value="">All</mat-option>
          <mat-option value="true">Yes</mat-option>
          <mat-option value="false">No</mat-option>
          <mat-option value="unknown">Unknown</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="contains-filter">
        <mat-label>Contains (search all columns)</mat-label>
        <input matInput [(ngModel)]="filters.contains" (input)="onFilterChange()" placeholder="Search..." />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
      <div class="actions">
        <button matButton="filled" color="primary" (click)="apply()">Apply</button>
        <button matButton="text" (click)="clear()">Clear</button>
      </div>
    </section>

    <section>
      <table mat-table [dataSource]="rows()" matSort (matSortChange)="onSort($event)" class="mat-elevation-z1">
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="date">Date</th>
          <td mat-cell *matCellDef="let r">{{ r.report?.beginDate | date: 'yyyy-MM-dd' }}</td>
        </ng-container>
        <ng-container matColumnDef="org">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="orgName">Reporting Org</th>
          <td mat-cell *matCellDef="let r">{{ r.report?.orgName || 'N/A' }}</td>
        </ng-container>
        <ng-container matColumnDef="ip">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="ip">IP</th>
          <td mat-cell *matCellDef="let r">{{ r.sourceIp }}</td>
        </ng-container>
        <ng-container matColumnDef="count">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="count">Count</th>
          <td mat-cell *matCellDef="let r">{{ r.count }}</td>
        </ng-container>
        <ng-container matColumnDef="disp">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="disposition">Disposition</th>
          <td mat-cell *matCellDef="let r">
            <span [class]="getDispositionClass(r.disposition)">
              <mat-icon class="status-icon">{{ getDispositionIcon(r.disposition) }}</mat-icon
              >{{ r.disposition }}
            </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="dkim">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="dkim">DKIM</th>
          <td mat-cell *matCellDef="let r">
            <span [class]="getDkimAuthClass(r)"
              ><mat-icon class="status-icon">{{ getDkimAuthIcon(r) }}</mat-icon
              >{{ getDkimAuthLabel(r) }}
            </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="spf">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="spf">SPF</th>
          <td mat-cell *matCellDef="let r">
            <span [class]="getSpfAuthClass(r)"
              ><mat-icon class="status-icon">{{ getSpfAuthIcon(r) }}</mat-icon
              >{{ getSpfAuthLabel(r) }}
            </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="forwarded">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="isForwarded">Forwarded</th>
          <td mat-cell *matCellDef="let r">
            <span [class]="getForwardedClass(r)">
              <mat-icon class="status-icon">{{ getForwardedIcon(r) }}</mat-icon
              >{{ getForwardedLabel(r) }}
            </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="country">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="country">Country</th>
          <td mat-cell *matCellDef="let r">{{ getCountryName(r.geoCountry) }}</td>
        </ng-container>
        <ng-container matColumnDef="from">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="headerFrom">Header From</th>
          <td mat-cell *matCellDef="let r">{{ r.headerFrom }}</td>
        </ng-container>
        <ng-container matColumnDef="envelopeTo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="envelopeTo">Envelope To</th>
          <td mat-cell *matCellDef="let r">{{ r.envelopeTo }}</td>
        </ng-container>
        <ng-container matColumnDef="auth">
          <th mat-header-cell *matHeaderCellDef>Auth Results</th>
          <td mat-cell *matCellDef="let r">
            <div class="auth">
              <span class="auth-label"><strong>DKIM:</strong></span>
              @if (r.dkimResults?.length) {
                <span class="auth-content">
                  @for (d of getDkimResultsForDisplay(r); track $index) {
                    <mat-icon
                      [ngClass]="{
                        'status-pass-icon': d.result === 'pass',
                        'status-fail-icon': d.result === 'fail',
                        'status-missing-icon': d.result !== 'pass' && d.result !== 'fail',
                      }"
                      >{{ getResultIcon(d.result) }}</mat-icon
                    >{{ d.domain }}
                  }
                </span>
              } @else {
                <span class="auth-content"><mat-icon class="status-missing-icon">remove</mat-icon></span>
              }
              <span class="auth-label"><strong>SPF:</strong></span>
              @if (r.spfResults?.length) {
                <span class="auth-content">
                  @for (s of getSpfResultsForDisplay(r); track $index) {
                    <mat-icon
                      [ngClass]="{
                        'status-pass-icon': s.result === 'pass',
                        'status-fail-icon': s.result === 'fail',
                        'status-missing-icon': s.result !== 'pass' && s.result !== 'fail',
                      }"
                      >{{ getResultIcon(s.result) }}</mat-icon
                    >{{ s.domain }}
                  }
                </span>
              } @else {
                <span class="auth-content"><mat-icon class="status-missing-icon">remove</mat-icon></span>
              }
              <div *ngIf="!r.dkimResults?.length && !r.spfResults?.length" class="auth-missing">⚪ No auth results</div>
            </div>
          </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let r">
            <button mat-button color="primary" (click)="viewXml(r); $event.stopPropagation()">XML</button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayed"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayed"
          class="element-row clickable-row"
          [class.selected-row]="selectedRecordId === row.id"
          (click)="openRecordDetails(row)"
        ></tr>
      </table>

      <mat-paginator
        [length]="total()"
        [pageSize]="pageSize()"
        [pageIndex]="page() - 1"
        [pageSizeOptions]="[10, 25, 50, 100]"
        showFirstLastButtons
        (page)="onPage($event)"
      ></mat-paginator>
    </section>
  </div>
</div>
