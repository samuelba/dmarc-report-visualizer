<div class="settings-container">
  <div class="settings-content">
    <mat-tab-group (selectedIndexChange)="onTabChange($event)" [selectedIndex]="selectedTabIndex()">
      <!-- Third-Party Senders Tab -->
      <mat-tab label="Third-Party Senders">
        <div class="tab-content">
          <mat-card>
            <mat-card-header>
              <mat-card-title>Email Service Providers</mat-card-title>
              <mat-card-subtitle>
                Configure legitimate third-party email senders (like SendGrid, Mailgun) that should NOT be marked as
                forwarded emails.
              </mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <div class="actions-bar">
                <button matButton="filled" color="primary" (click)="openCreateDialog()">
                  <mat-icon>add</mat-icon>
                  Add Third-Party Sender
                </button>
              </div>

              @if (loadingSenders()) {
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              }

              <table mat-table [dataSource]="thirdPartySenders()" class="senders-table">
                <!-- Enabled Column -->
                <ng-container matColumnDef="enabled">
                  <th mat-header-cell *matHeaderCellDef>Enabled</th>
                  <td mat-cell *matCellDef="let sender">
                    <mat-slide-toggle
                      [checked]="sender.enabled"
                      (change)="toggleEnabled(sender, $event)"
                      color="primary"
                    >
                    </mat-slide-toggle>
                  </td>
                </ng-container>

                <!-- Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Name</th>
                  <td mat-cell *matCellDef="let sender">
                    <div class="sender-name">
                      <strong>{{ sender.name }}</strong>
                      @if (sender.description) {
                        <div class="description">{{ sender.description }}</div>
                      }
                    </div>
                  </td>
                </ng-container>

                <!-- DKIM Pattern Column -->
                <ng-container matColumnDef="dkimPattern">
                  <th mat-header-cell *matHeaderCellDef>DKIM Pattern</th>
                  <td mat-cell *matCellDef="let sender">
                    @if (sender.dkimPattern) {
                      <code class="pattern">{{ sender.dkimPattern }}</code>
                    } @else {
                      <span class="no-pattern">-</span>
                    }
                  </td>
                </ng-container>

                <!-- SPF Pattern Column -->
                <ng-container matColumnDef="spfPattern">
                  <th mat-header-cell *matHeaderCellDef>SPF Pattern</th>
                  <td mat-cell *matCellDef="let sender">
                    @if (sender.spfPattern) {
                      <code class="pattern">{{ sender.spfPattern }}</code>
                    } @else {
                      <span class="no-pattern">-</span>
                    }
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Actions</th>
                  <td mat-cell *matCellDef="let sender">
                    <button matIconButton (click)="openEditDialog(sender)" matTooltip="Edit">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button matIconButton color="warn" (click)="deleteSender(sender)" matTooltip="Delete">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>

              @if (thirdPartySenders().length === 0 && !loadingSenders()) {
                <div class="empty-state">
                  <mat-icon>inbox</mat-icon>
                  <p>No third-party senders configured</p>
                  <button mat-raised-button color="primary" (click)="openCreateDialog()">Add Your First Sender</button>
                </div>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Reprocessing Tab -->
      <mat-tab label="Reprocessing">
        <div class="tab-content">
          <mat-card>
            <mat-card-header>
              <mat-card-title>Reprocess DMARC Records</mat-card-title>
              <mat-card-subtitle>
                Re-analyze all existing records with the current forwarding detection rules and third-party sender
                configurations.
              </mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <div class="reprocessing-section">
                <div class="info-box">
                  <mat-icon color="primary">info</mat-icon>
                  <div class="info-content">
                    <strong>When to reprocess:</strong>
                    <ul>
                      <li>After adding or modifying third-party sender configurations</li>
                      <li>After updating forwarding detection logic</li>
                      <li>To ensure all records reflect current settings</li>
                    </ul>
                    <p class="warning">
                      ⚠️ Reprocessing may take several minutes/hours depending on the number of records and workers
                      configured.
                    </p>
                  </div>
                </div>

                <!-- Date Range Selector -->
                <div class="date-range-selector">
                  <mat-form-field appearance="outline" class="date-range-field">
                    <mat-label>Date Range (optional)</mat-label>
                    <mat-date-range-input [rangePicker]="picker" [disabled]="isReprocessing()">
                      <input matStartDate [(ngModel)]="dateFrom" placeholder="Start date" />
                      <input matEndDate [(ngModel)]="dateTo" placeholder="End date" />
                    </mat-date-range-input>
                    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-date-range-picker #picker></mat-date-range-picker>
                    <mat-hint
                      >Select a date range to reprocess only specific records. Leave empty to reprocess all
                      records.</mat-hint
                    >
                  </mat-form-field>
                </div>

                @if (currentJob()) {
                  <div class="current-job">
                    <h3>
                      <mat-icon [color]="getStatusColor(currentJob()!.status)">
                        {{ getStatusIcon(currentJob()!.status) }}
                      </mat-icon>
                      Current Job
                    </h3>

                    <div class="job-details">
                      <div class="job-stat">
                        <span class="label">Status:</span>
                        <mat-chip [color]="getStatusColor(currentJob()!.status)">
                          {{ currentJob()!.status | uppercase }}
                        </mat-chip>
                      </div>

                      @if (currentJob()!.dateFrom || currentJob()!.dateTo) {
                        <div class="job-stat">
                          <span class="label">Date Range:</span>
                          <span>
                            @if (currentJob()!.dateFrom && currentJob()!.dateTo) {
                              {{ formatDate(currentJob()!.dateFrom) }} to {{ formatDate(currentJob()!.dateTo) }}
                            } @else if (currentJob()!.dateFrom) {
                              From {{ formatDate(currentJob()!.dateFrom) }}
                            } @else if (currentJob()!.dateTo) {
                              Up to {{ formatDate(currentJob()!.dateTo) }}
                            }
                          </span>
                        </div>
                      }

                      <div class="job-stat">
                        <span class="label">Progress:</span>
                        <span
                          >{{ currentJob()!.processedRecords | number }} /
                          {{ currentJob()!.totalRecords | number }} records</span
                        >
                      </div>

                      @if (currentJob()!.status === 'running' || currentJob()!.status === 'pending') {
                        <mat-progress-bar mode="determinate" [value]="getProgress(currentJob()!)" class="progress-bar">
                        </mat-progress-bar>
                        <div class="progress-text">{{ getProgress(currentJob()!) }}%</div>
                      }

                      @if (currentJob()!.status === 'completed') {
                        <div class="results">
                          <div class="result-item">
                            <mat-icon class="icon-forwarded">forward_to_inbox</mat-icon>
                            <span>Forwarded: {{ currentJob()!.forwardedCount | number }}</span>
                          </div>
                          <div class="result-item">
                            <mat-icon class="icon-not-forwarded">email</mat-icon>
                            <span>Not Forwarded: {{ currentJob()!.notForwardedCount | number }}</span>
                          </div>
                          <div class="result-item">
                            <mat-icon class="icon-unknown">help</mat-icon>
                            <span>Unknown: {{ currentJob()!.unknownCount | number }}</span>
                          </div>
                        </div>
                      }

                      @if (currentJob()!.errorMessage) {
                        <div class="error-message">
                          <mat-icon color="warn">error</mat-icon>
                          {{ currentJob()!.errorMessage }}
                        </div>
                      }

                      <div class="job-stat">
                        <span class="label">Duration:</span>
                        <span>{{ formatDuration(currentJob()!.startedAt, currentJob()!.completedAt) }}</span>
                      </div>
                    </div>
                  </div>
                }

                <div class="action-bar">
                  <button
                    matButton="filled"
                    color="primary"
                    (click)="startReprocessing()"
                    [disabled]="isReprocessing()"
                  >
                    <mat-icon>refresh</mat-icon>
                    @if (isReprocessing()) {
                      Reprocessing in Progress...
                    } @else {
                      Start Reprocessing
                    }
                  </button>

                  @if (isReprocessing() && currentJob()) {
                    <button matButton="filled" color="warn" (click)="cancelReprocessing()" class="cancel-button">
                      <mat-icon>cancel</mat-icon>
                      Cancel Reprocessing
                    </button>
                  }
                </div>
              </div>

              <!-- Job History -->
              @if (reprocessingHistory().length > 0) {
                <div class="history-section">
                  <h3>Recent Jobs</h3>
                  <table mat-table [dataSource]="reprocessingHistory()" class="jobs-table">
                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                      <th mat-header-cell *matHeaderCellDef>Status</th>
                      <td mat-cell *matCellDef="let job">
                        <mat-chip [color]="getStatusColor(job.status)" class="status-chip">
                          <mat-icon>{{ getStatusIcon(job.status) }}</mat-icon>
                          {{ job.status | uppercase }}
                        </mat-chip>
                      </td>
                    </ng-container>

                    <!-- Created Column -->
                    <ng-container matColumnDef="created">
                      <th mat-header-cell *matHeaderCellDef>Started</th>
                      <td mat-cell *matCellDef="let job">{{ formatDate(job.startedAt) }}</td>
                    </ng-container>

                    <!-- Range Column -->
                    <ng-container matColumnDef="range">
                      <th mat-header-cell *matHeaderCellDef>Date Range</th>
                      <td mat-cell *matCellDef="let job">
                        @if (job.dateFrom || job.dateTo) {
                          @if (job.dateFrom && job.dateTo) {
                            {{ formatDate(job.dateFrom) }} – {{ formatDate(job.dateTo) }}
                          } @else if (job.dateFrom) {
                            From {{ formatDate(job.dateFrom) }}
                          } @else {
                            Up to {{ formatDate(job.dateTo!) }}
                          }
                        } @else {
                          All records
                        }
                      </td>
                    </ng-container>

                    <!-- Records Column -->
                    <ng-container matColumnDef="records">
                      <th mat-header-cell *matHeaderCellDef>Records</th>
                      <td mat-cell *matCellDef="let job">
                        {{ job.processedRecords | number }} / {{ job.totalRecords | number }}
                      </td>
                    </ng-container>

                    <!-- Results Column -->
                    <ng-container matColumnDef="results">
                      <th mat-header-cell *matHeaderCellDef>Results</th>
                      <td mat-cell *matCellDef="let job">
                        @if (job.status === 'completed') {
                          <span class="results-summary">
                            ↪️{{ job.forwardedCount }} / 📧{{ job.notForwardedCount }} / ❓{{ job.unknownCount }}
                          </span>
                        } @else {
                          -
                        }
                      </td>
                    </ng-container>

                    <!-- Duration Column -->
                    <ng-container matColumnDef="duration">
                      <th mat-header-cell *matHeaderCellDef>Duration</th>
                      <td mat-cell *matCellDef="let job">
                        {{ formatDuration(job.startedAt, job.completedAt) }}
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="jobDisplayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: jobDisplayedColumns"></tr>
                  </table>
                </div>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>
